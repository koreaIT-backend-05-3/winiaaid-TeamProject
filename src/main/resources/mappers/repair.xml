<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.winiaaid.domain.repair.RepairRepository">
    <resultMap id="repairServiceInfoMap" type="com.project.winiaaid.domain.repair.RepairServiceInfo">
        <association property="productInfoEntity" javaType="com.project.winiaaid.domain.repair.ProductInfoEntity">
            <id property="repair_service_code" column="repair_service_code"/>
            <result property="product_category_name" column="product_category_name"/>
            <result property="product_detail_name" column="product_detail_name"/>
            <result property="model_number" column="model_number"/>
            <result property="trouble_code" column="trouble_code"/>
            <result property="trouble_symptom" column="trouble_symptom"/>
            <result property="description" column="description"/>
            <result property="company_code" column="company_code"/>
            <result property="company_name" column="company_name"/>
        </association>
        <association property="userInfoEntity" javaType="com.project.winiaaid.domain.repair.UserInfoEntity">
            <result property="user_name" column="user_name"/>
            <result property="email" column="email"/>
            <result property="main_phone_number" column="main_phone_number"/>
            <result property="sub_phone_number" column="sub_phone_number"/>
            <result property="postal_code" column="postal_code"/>
            <result property="main_address" column="main_address"/>
            <result property="detail_address" column="detail_address"/>
        </association>
        <association property="reservationInfoEntity" javaType="com.project.winiaaid.domain.repair.ReservationInfoEntity">
            <result property="engineer_name" column="engineer_name"/>
            <result property="service_type" column="service_type"/>
            <result property="completed_flag" column="completed_flag"/>
            <result property="request_date" column="request_date"/>
            <result property="reservation_date" column="reservation_date"/>
            <result property="note" column="note"/>
            <result property="total_count" column="total_count"/>
        </association>
    </resultMap>

    <insert id="addRepairServiceRequest" parameterType="com.project.winiaaid.domain.repair.RepairServiceInfo">
        insert into
            repair_service_table
        values(
            #{productInfoEntity.repair_service_code},
            #{productInfoEntity.product_category_code},
            #{productInfoEntity.product_code},
            #{productInfoEntity.model_code},
            #{productInfoEntity.trouble_code},
            #{productInfoEntity.description},

            #{userInfoEntity.user_code},
            #{userInfoEntity.user_name},
            #{userInfoEntity.main_phone_number},
            #{userInfoEntity.sub_phone_number},
            #{userInfoEntity.email},
            #{userInfoEntity.postal_code},
            #{userInfoEntity.main_address},
            #{userInfoEntity.detail_address},

            #{reservationInfoEntity.engineer_code},
            #{reservationInfoEntity.service_type},
            #{reservationInfoEntity.completed_flag},
            #{reservationInfoEntity.reservation_date},
            NOW(),
            null
        );
    </insert>

    <select id="findRepairServiceByUserCode" parameterType="HashMap" resultMap="repairServiceInfoMap">
        SELECT
            rst.repair_service_code,
            rst.description,
            rst.user_name,
            rst.main_phone_number,
            rst.sub_phone_number,
            rst.email,
            rst.service_type,
            rst.completed_flag,
            rst.request_date,
            rst.reservation_date,
            rst.note,
            rst.main_address,
            rst.detail_address,
            rst.postal_code,
            rst.trouble_code,

            wpm.product_category_name,

            wpd.product_detail_name,

            pct.company_code,
            pct.company_name,

            pmd.model_number,

            tst.trouble_symptom,

            em.engineer_name,

            rst_total_count.total_count
        FROM
            repair_service_table rst
            LEFT OUTER JOIN winia_product_mst wpm ON(wpm.product_category_code = rst.product_category_code)
            LEFT OUTER JOIN winia_product_dtl wpd ON(wpd.product_code = rst.product_code)
            LEFT OUTER JOIN product_company_table pct ON(pct.company_code = wpm.company_code)
            LEFT OUTER JOIN product_model_detail pmd ON(pmd.model_code = rst.model_code)
            LEFT OUTER JOIN trouble_symptom_table tst ON(tst.trouble_code = rst.trouble_code)
            LEFT OUTER JOIN engineer_mst em ON(em.engineer_code = rst.engineer_code)
            LEFT OUTER JOIN (select
                                COUNT(*) AS total_count
                            from
                                repair_service_table rst
                                <if test='company != "all"'>
                                    LEFT OUTER JOIN winia_product_mst wpm ON(wpm.product_category_code = rst.product_category_code)
                                    LEFT OUTER JOIN product_company_table pct ON(pct.company_code = wpm.company_code)
                                </if>
                            where
                                user_code = 0
                                <choose>
                                    <when test='company == "winia"'>
                                        and pct.company_code = 2
                                    </when>
                                    <when test='company == "daewoo"'>
                                        and pct.company_code = 1
                                    </when>
                                </choose>) rst_total_count ON(1 = 1)
        WHERE
            rst.user_code = #{user_code}
            <choose>
                <when test='company == "winia"'>
                    and pct.company_code = 2
                </when>
                <when test='company == "daewoo"'>
                    and pct.company_code = 1
                </when>
            </choose>
        LIMIT #{page}, #{limit};
    </select>

</mapper>

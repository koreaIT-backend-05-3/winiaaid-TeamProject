<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.winiaaid.domain.recall.RecallRepository">
	<insert id="addRecallRequest" parameterType="com.project.winiaaid.domain.recall.Recall">
		insert into
			recall_service_table
		values(
			#{model_code},
			#{id2},
			#{service_code},
			3,
			#{model_code},
			now(),
			1,
			0,
			#{user_code},
			#{user_name},
			#{main_phone_number},
			#{sub_phone_number},
			#{postal_code},
			#{main_address},
			#{detail_address}
		);
	</insert>
	
	<select id="getRecallRequest" parameterType="hashmap" resultType="com.project.winiaaid.domain.recall.Recall">
		select
			rst.service_code,
			rst.request_date,
			rst.progress_status,
			rst.note,
			rst.user_code,
			rst.user_name,
			rst.main_phone_number,
			rst.sub_phone_number,
			rst.postal_code,
			rst.main_address,
			rst.detail_address,

			stt.service_type_name,

			pmd.model_number
		from
			recall_service_table rst
			LEFT OUTER JOIN service_type_table stt on(stt.service_type_code = rst.service_type_code)
			LEFT OUTER JOIN product_model_detail pmd on(pmd.model_code = rst.model_code)
		where
			service_code = #{service_code}
			and
			user_name = #{user_name}
			and
			user_code = #{user_code};
	</select>

	<select id="findServiceCode" parameterType="HashMap" resultType="com.project.winiaaid.domain.recall.RecallServiceCode">
		select
			IFNULL(MAX(id2), 0) + 1 as id2,
			RPAD(#{temp_service_code}, CHAR_LENGTH(#{temp_service_code}) + CHAR_LENGTH((IFNULL(MAX(id2), 1) + 1)) + 1, '0') + IFNULL(MAX(id2), 0) + 1 as service_code
		from
			recall_service_table
		where
			id1 = #{model_code};
	</select>
</mapper>
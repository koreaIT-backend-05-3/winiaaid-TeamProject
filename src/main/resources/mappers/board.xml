<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.project.winiaaid.domain.board.BoardRepository">

	<resultMap id="boardResultMap" type="com.project.winiaaid.domain.board.Board">
		<id property="company_code" column="company_code"/>
		<result property="board_content" column="board_content"/>
		<result property="progress_status" column="progress_status"/>
		<result property="create_date" column="create_date"/>
		<result property="user_name" column="user_name"/>
		<collection property="file_list" ofType="com.project.winiaaid.domain.board.BoardFile">
			<result property="file_name" column="file_name"/>
		</collection>
	</resultMap>
	
	<insert id="insertBoard" parameterType="com.project.winiaaid.domain.board.Board">
		INSERT INTO
			board_mst
		values(
			#{board_type_code},
			#{id2},
			#{board_code},
			#{board_type_code},
			#{user_code},
			#{company_code},
			#{response_flag},
			#{board_title},
			#{board_content},
			#{progress_status},
			NULL,
			NOW(),
			NOW()
		);
	</insert>
	
	<insert id="insertBoardFile" parameterType="java.util.List">
		insert into
			board_file
		values
			<foreach collection="file_list" item="file" separator="," open="" close="">
			(
				0,
				#{file.file_name},
				#{file.board_code},
				now(),
				now()
			)
			</foreach>
	</insert>

	<select id="findBoardCode" parameterType="com.project.winiaaid.domain.board.Board" resultType="com.project.winiaaid.domain.board.BoardCode">
		select
			IFNULL(MAX(id2), 0) + 1 as id2,
			RPAD(#{temp_board_code}, CHAR_LENGTH(#{temp_board_code}) + CHAR_LENGTH((IFNULL(MAX(id2), 1) + 1)) + 1, '0') + IFNULL(MAX(id2), 0) + 1 as board_code
		from
			board_mst
		where
			id1 = #{board_type_code}
	</select>
	
	<select id="findBoardListByBoardType" parameterType="hashmap" resultType="com.project.winiaaid.domain.board.Board">
		SELECT
			bm.board_code,
			bm.user_code,
			bm.company_code,
			bm.board_title,
			bm.board_content,
			bm.progress_status,
			bm.create_date,
			bf.file_name,
			um.user_name,
			tc.total_count
		FROM
			board_mst bm
			LEFT OUTER JOIN board_file bf ON(bf.board_code = bm.board_code)
			LEFT OUTER JOIN user_mst um ON(um.user_code = bm.user_code)
			LEFT OUTER JOIN (select
								count(*) as total_count
							from
								board_mst
							where
							<if test="board_type_code != 2">
								user_code = #{user_code}
								AND
							</if>
							board_type_code = #{board_type_code}) tc on(1=1)
			
		WHERE
			<if test="board_type_code != 2">
				bm.user_code = #{user_code}
				AND
			</if>
			bm.board_type_code = #{board_type_code}
		LIMIT #{page}, 10;
	
	</select>
	<select id="findBoardByBoardCode" parameterType="Integer" resultMap="boardResultMap">
		SELECT
			bm.company_code,
			bm.board_title,
			bm.board_content,
			bm.progress_status,
			bm.create_date,
			bf.file_name,
			um.user_name
		FROM
			board_mst bm
			LEFT OUTER JOIN board_file bf ON(bf.board_code = bm.board_code)
			LEFT OUTER JOIN user_mst um ON(um.user_code = bm.user_code)
		WHERE
			bm.board_code = #{board_code};
	</select>
	
	<select id="findBoardFileListByBoardCode" parameterType="Integer" resultType="com.project.winiaaid.domain.board.BoardFile">
		select
			file_name
		from
			board_file
		where
			board_code = #{board_code}
	</select>
	
	<delete id="deleteBoardByBoardCode"  parameterType="Integer">
			delete
			from
				board_mst
			where
				board_code = #{board_code};
	</delete>

</mapper>

